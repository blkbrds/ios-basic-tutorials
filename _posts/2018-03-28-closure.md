---
layout: post
title: Closure
---

# CLOSURE



## Äáº·t váº¥n Ä‘á»:

KhÃ´ng Ã­t láº§n chÃºng ta táº¡o ra nhá»¯ng function tÆ°Æ¡ng tÃ¡c vá»›i webservice. 

NguyÃªn lÃ½ cá»§a nÃ³ lÃ  gá»­i Ä‘i `request` vÃ  nháº­n vá»  `response`, Ä‘Ã¢y lÃ  quÃ¡ trÃ¬nh báº¥t Ä‘á»“ng bá»™ nÃªn chÃºng ta khÃ´ng biáº¿t Ä‘Æ°á»£c sáº½ diá»…n ra trong bao lÃ¢u vÃ  káº¿t thÃºc khi nÃ o.

Váº­y lÃ m sao Ä‘á»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c quÃ¡ trÃ¬nh nÃ y vÃ  tráº£ vá» má»™t thÃ´ng bÃ¡o khi nÃ³ káº¿t thÃºc?  `CLOSURE` sáº½ giÃºp chÃºng ta giáº£i quyáº¿t Ä‘Æ°á»£c nhá»¯ng váº¥n Ä‘á» trÃªn.



## Closure:

**<u>KhÃ¡i niá»‡m</u>**: 

`Closures are self-contained blocks of functionality` (lÃ  má»™t khá»‘i lá»‡nh khÃ©p kÃ­n).

Closure lÃ  má»™t block code, cÃ³ thá»ƒ tÃ¡ch ra Ä‘á»ƒ tÃ¡i sá»­ dá»¥ng. Hiá»ƒu Ä‘Æ¡n giáº£n hÆ¡n thÃ¬ Closure lÃ  function, nhÆ°ng khuyáº¿t danh. `Closure` cÃ³ thá»ƒ Ä‘Æ°á»£c gÃ¡n cho biáº¿n hoáº·c lÃ  tham sá»‘ cá»§a function.

 `Closure` trong Swift tÆ°Æ¡ng tá»± nhÆ° `block` trong Objective-C vÃ  `lambdas` trong cÃ¡c ngÃ´n ngá»¯ khÃ¡c.

**<u>CÃ¡ch dÃ¹ng:</u>**

`Closure` cÃ³ thá»ƒ Ä‘Æ°á»£c gÃ¡n cho biáº¿n hoáº·c lÃ  tham sá»‘ cá»§a function.

`Closure` cÃ³ thá»ƒ **capture** vÃ  lÆ°u giá»¯ cÃ¡c tham chiáº¿u Ä‘áº¿n báº¥t kÃ¬ `constants` hoáº·c `variables` tá»« ngá»¯ cáº£nh mÃ  chÃºng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a.

**<u>CÃº phÃ¡p:</u>**

```
{ (params) -> returnType in
	//statements
}
```

> *ChÃº Ã½*: Kiá»ƒu optional cá»§a closure
>
> ((parameter) -> returnType)?

**<u>*CÃ¡c dáº¡ng Closure:*</u>** Closure cÃ³ má»™t trong 3 hÃ¬nh thá»©c

- Global function: Closure cÃ³ tÃªn vÃ  khÃ´ng capture báº¥t kÃ¬ giÃ¡ trá»‹ nÃ o. LÃ  má»™t function bÃ¬nh thÆ°á»ng.

  ```swift
  func addTwoNumbers(number1: Int, number2: Int) -> Int {
  	return number1 + number2
  }
  addTwoNumbers(number1: 8, number2: 2) // result is 10
  ```

- Nested functions: (CÃ¡c hÃ m lá»“ng nhau) lÃ  Closure cÃ³ tÃªn vÃ  cÃ³ thá»ƒ capture giÃ¡ trá»‹ khi káº¿t thÃºc function.

  ```swift
  func makeIncrementer(forIncrement amount: Int) -> () -> Int {
      var runningTotal = 0
      func incrementer() -> Int {
          runningTotal += amount
          return runningTotal
      }
      return incrementer
  }
  ```

- Closure expressions: Vá»›i cÃº phÃ¡p Ä‘Æ¡n giÃ£n, ngáº¯n gá»n. KhÃ´ng cáº§n tÃªn vÃ  cÅ©ng cÃ³ thá»ƒ capture giÃ¡ trá»‹ trong pháº¡m vi ngá»¯ cáº£nh mÃ  chÃºng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a

  ```swift
  let sum: (Int, Int) -> Int = { (number1, number2) -> Int in
  	return number1 + number2
  }
  closure(8,2) // the result is 10
  ```

`Closure` lÃ  má»™t kiá»ƒu tham chiáº¿u. CÃ¡c báº¡n xem vÃ­ dá»¥ á»Ÿ dÆ°á»›i nhÃ©.

```swift
let incrementByTen = makeIncrementer(forIncrement: 10)

incrementByTen()
// returns a value of 10
incrementByTen()
// returns a value of 20
incrementByTen()
// returns a value of 30

let incrementBySeven = makeIncrementer(forIncrement: 7)
incrementBySeven()
// returns a value of 7

incrementByTen()
// returns a value of 40
```



## RÃºt gá»n closure:

### Tá»± suy luáº­n kiá»ƒu dá»¯ liá»‡u

Khi truyá»n closure vÃ o function nhÆ° má»™t Ä‘á»‘i sá»‘, Swift cÃ³ thá»ƒ suy luáº­n kiá»ƒu dá»¯ liá»‡u cÃ¡c tham sá»‘ cá»§a nÃ³ vÃ  giÃ¡ trá»‹ nÃ³ tráº£ vá». 

VÃ­ dá»¥: phÆ°Æ¡ng thá»©c `sorted(by:)` Ä‘Æ°á»£c gá»i cÃ³ tham sá»‘ lÃ  má»™t `closure` vá»›i kiá»ƒu lÃ  `(String, String) -> Bool`. NghÄ©a lÃ , chÃºng ta cÃ³ thá»ƒ lÆ°á»£c bá» `(String, String)` vÃ  `Bool` khi Ä‘á»‹nh nghÄ©a closure nÃ y. Dáº¥u mÅ©i tÃªn tráº£ vá» `->` vÃ  cáº·p ngoáº·c `()` xung quang tÃªn cÃ¡c tham sá»‘ cÅ©ng cÃ³ thá»ƒ Ä‘Æ°á»£c bá» qua

```
// Full
reversedNames = names.sorted(by: { (s1: String, s2: String) -> Bool in
    return s1 > s2
})

// Compact
reversedNames = names.sorted(by: { s1, s2 in return s1 > s2 } )
```

### Ngáº§m Ä‘á»‹nh kiá»ƒu tráº£ vá» tá»« Single-Expression Closures

Äá»‘i vá»›i **Single-Expression Closures,** pháº§n body cá»§a closure chá»‰ lÃ  má»™t biá»ƒu thá»©c Ä‘iá»u kiá»‡n. Ngay lÃºc nÃ y swift cho phÃ©p bá» qua tá»« khoÃ¡ `return`.

**VÃ­ dá»¥:**

```
reversedNames = names.sorted(by: { s1, s2 in s1 > s2 } )
```

### TÃªn Ä‘á»‘i sá»‘ viáº¿t táº¯t

Swift sáº½ tá»± Ä‘á»™ng cung cáº¥p tÃªn Ä‘á»‘i sá»‘ viáº¿t táº¯t cho khá»‘i lá»‡nh closure, cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ chá»‰ cÃ¡c giÃ¡ trá»‹ cá»§a Ä‘á»‘i sá»‘ trong closure báº±ng tÃªn `$0` , `$1`, `$2`...

Náº¿u sá»­ dá»¥ng tÃªn Ä‘á»‘i sá»‘ viáº¿t táº¯t trong closure, chÃºng ta cÃ³ thá»ƒ bá» qua danh sÃ¡ch Ä‘á»‘i sá»‘ cá»§a closure khi Ä‘á»‹nh nghÄ©a, sá»‘ lÆ°á»£ng vÃ  kiá»ƒu dá»¯ liá»‡u cá»§a cÃ¡c Ä‘á»‘i sá»‘ viáº¿t táº¯t nÃ y sáº½ Ä‘Æ°á»£c suy ra tá»« kiá»ƒu dá»¯ liá»‡u mÃ  function mong muá»‘n. Tá»« khoÃ¡ `in` cÅ©ng cÃ³ thá»ƒ Ä‘Æ°á»£c bá» qua:

```
reversedNames = names.sorted(by: { $0 > $1 } )
```

Trong trÆ°á»ng há»£p nÃ y, `$0` vÃ  `$1` Ã¡m chá»‰ Ä‘áº¿n Ä‘á»‘i sá»‘ Ä‘áº§u tiÃªn vÃ  thá»© hai cá»§a closure.

### Operator Methods (PhÆ°Æ¡ng thá»©c toÃ¡n tá»­)

CÃ³ má»™t cÃ¡ch ngáº¯n hÆ¡n Ä‘á»ƒ viáº¿t biá»ƒu thá»©c closure á»Ÿ trÃªn. ChÃºng ta cÃ³ thá»ƒ cáº£i tiáº¿n toÃ¡n tá»­ lá»›n hÆ¡n `>` nhÆ° má»™t method cÃ³ hai tham sá»‘ kiá»ƒu `String` vÃ  tráº£ vá» má»™t giÃ¡ trá»‹ kiá»ƒu `Bool`. Äiá»u nÃ y ráº¥t phÃ¹ há»£p vá»›i phÆ°Æ¡ng thá»©c `sorted(by:)`.

```
static func > (left: String, right: String) -> Bool {
	if left > right { 
		return true 
	} else {
        return false
	}
}

reversedNames = names.sorted(by: >)
```



## Trailing closure:

Trailing closure lÃ  gÃ¬?

**Trailing closure** lÃ  cÃ¡ch viáº¿t má»™t biá»ƒu thá»©c `closure` náº±m ngoÃ i cáº·p dáº¥u ngoáº·c Ä‘Æ¡n cá»§a function chá»©a nÃ³.

Khi má»™t function há»™i Ä‘á»§ cÃ¡c yáº¿u tá»‘ sau:

- CÃ³ tham sá»‘ lÃ  má»™t biá»ƒu thá»©c closure.
- Tham sá»‘ closure pháº£i Ä‘Æ°á»£c khai bÃ¡o cuá»‘i cÃ¹ng trong dÃ¡nh sÃ¡ch tham sá»‘ cá»§a function.

ThÃ¬ báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng cÃº phÃ¡p **trailing closure**

Closure dÆ°á»›i Ä‘Ã¢y Ä‘Æ°á»£c viáº¿t sau ngoáº·c Ä‘Æ¡n khi gá»i function, máº·c dÃ¹ nÃ³ váº«n lÃ  má»™t Ä‘á»‘i sá»‘ cho function Ä‘Ã³. Khi báº¡n sá»­ dá»¥ng cÃº phÃ¡p **trailing closure**, báº¡n khÃ´ng cáº§n pháº£i ghi nhÃ£n Ä‘á»‘i sá»‘ khi gá»i function.

```swift
func someFunctionThatTakesAClosure(closure: () -> Void) {
    // function body
}

// DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡ch viáº¿t Ä‘áº§y Ä‘á»§:
someFunctionThatTakesAClosure(closure: {
    // closure's body
})

// DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡ch viáº¿t sá»­ dá»¥ng trailing closure:
someFunctionThatTakesAClosure() {
    // trailing closure's body
}
```

Closure `sorted(by:)` á»Ÿ pháº§n rÃºt gá»n closure cÃ³ thá»ƒ Ä‘Æ°á»£c viáº¿t bÃªn ngoÃ i cáº·p ngoáº·c nhá»n cá»§a funtion nhÆ° sau:

```swift
reversedNames = names.sorted() { $0 > $1 }
```

Náº¿u Closure lÃ  Ä‘á»‘i sá»‘ duy nháº¥t cá»§a má»™t function, báº¡n khÃ´ng cáº§n pháº£i viáº¿t cáº·p ngoáº·c Ä‘Æ¡n sau tÃªn function khi gá»i:

```swift
reversedNames = names.sorted { $0 > $1 }
```



## Capturing values

Má»™t closure cÃ³ thá»ƒ **capture** (náº¯m giá»¯) cÃ¡c háº±ng sá»‘ vÃ  biáº¿n tá»« ngá»¯ cáº£nh xung quanh lÃºc nÃ³ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a. Closure sau Ä‘Ã³ cÃ³ thá»ƒ gÃ¡n vÃ  sá»­a Ä‘á»•i cÃ¡c giÃ¡ trá»‹ cá»§a cÃ¡c biáº¿n tá»« bÃªn trong body cá»§a nÃ³, ngay cáº£ khi pháº¡m vi ban Ä‘áº§u mÃ  xÃ¡c Ä‘á»‹nh cÃ¡c háº±ng sá»‘ vÃ  cÃ¡c biáº¿n khÃ´ng cÃ²n tá»“n táº¡i.

Trong Swift, hÃ¬nh thá»©c Ä‘Æ¡n giáº£n nháº¥t cá»§a má»™t closure cÃ³ thá»ƒ náº¯m báº¯t cÃ¡c giÃ¡ trá»‹ lÃ  **nested function**. Má»™t function Ä‘Æ°á»£c lá»“ng vÃ o má»™t function khÃ¡c cÃ³ thá»ƒ náº¯m báº¯t báº¥t ká»³ Ä‘á»‘i sá»‘ nÃ o cá»§a function bÃªn ngoÃ i vÃ  cÅ©ng cÃ³ thá»ƒ náº¯m báº¯t báº¥t ká»³ háº±ng sá»‘ vÃ  biáº¿n nÃ o Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong function bÃªn ngoÃ i.

ÄÃ¢y lÃ  vÃ­ dá»¥ vá» má»™t function cÃ³ tÃªn lÃ  `makeIncrementer()`, nÃ³ chá»©a má»™t nested function Ä‘Æ°á»£c gá»i lÃ  `incrementer()`. Function `incrementer()` lá»“ng nhau, ghi láº¡i hai giÃ¡ trá»‹ `runningTotal` vÃ  `amount`, tá»« ngá»¯ cáº£nh xung quanh nÃ³. Sau khi náº¯m giá»¯ cÃ¡c giÃ¡ trá»‹ nÃ y, `incrementer()` Ä‘Æ°á»£c tráº£ vá» bá»Ÿi `makeIncrementer()` nhÆ° lÃ  má»™t closure tÄƒng dáº§n sá»‘ tiá»n má»—i láº§n nÃ³ Ä‘Æ°á»£c gá»i.

```swift
func makeIncrementer(forIncrement amount: Int) -> () -> Int {
    var runningTotal = 0
    func incrementer() -> Int {
        runningTotal += amount
        return runningTotal
    }
    return incrementer
}
```

Kiá»ƒu tráº£ vá» cá»§a `makeIncrementer()` lÃ  `() -> Int` Äiá»u nÃ y cÃ³ nghÄ©a lÃ  nÃ³ tráº£ vá» má»™t function chá»© khÃ´ng pháº£i lÃ  má»™t giÃ¡ trá»‹ Ä‘Æ¡n giáº£n.

Function `makeIncrementer(forIncrement:)` táº¡o má»™t biáº¿n cÃ³ tÃªn `runningTotal`, Ä‘á»ƒ lÆ°u trá»¯ tá»•ng sá»‘ hiá»‡n táº¡i sau má»—i láº§n tÄƒng, vá»›i giÃ¡ trá»‹ khá»Ÿi táº¡o lÃ  `0`

Function `makeIncrementer(forIncrement:)` cÃ³ duy nháº¥t má»™t tham sá»‘ lÃ  `amount`. Function `makeIncrementer()` Ä‘á»‹nh nghÄ©a má»™t **nested function** Ä‘Æ°á»£c gá»i lÃ  `incrementer()`. Function nÃ y tÄƒng dáº§n giÃ¡ trá»‹ `runningTotal` vá»›i giÃ¡ trá»‹ `amount`

ÄÃ¢y lÃ  má»™t vÃ­ dá»¥ vá» `makeIncrementer()` khi thá»±c hiá»‡n:

```swift
let incrementByTen = makeIncrementer(forIncrement: 10)
```

VÃ­ dá»¥ nÃ y thiáº¿t láº­p má»™t háº±ng sá»‘ Ä‘Æ°á»£c gá»i lÃ  `incrementByTen` Ä‘á»ƒ refer má»™t function `makeIncrementer()` mÃ  thÃªm 10 vÃ o `runningTotal` má»—i khi nÃ³ Ä‘Æ°á»£c gá»i. 

```swift
incrementByTen()
// returns a value of 10
incrementByTen()
// returns a value of 20
incrementByTen()
// returns a value of 30
```



## Escaping vÃ  Non-escaping trong Closure:

Trong swift 1 vÃ  swift 2 `closure` máº·c Ä‘á»‹nh sáº½ lÃ  `escaping closure`. Tá»« swift 3 trá»Ÿ Ä‘i thÃ¬ cÃ³ má»™t chÃºt thay Ä‘á»•i, `closure` máº·c Ä‘á»‹nh giá» sáº½ lÃ  `non-escaping closure`.

> Táº¡i sao láº¡i cÃ³ sá»± thay Ä‘á»•i Ä‘Ã³? MÃ¬nh cÃ¹ng nhau tháº£o luáº­n nhÃ©.

### Non-Escaping Closure

- Khi báº¡n truyá»n `closure` nhÆ° lÃ  tham sá»‘ cá»§a function.
- Báº¡n gá»i nÃ³ trong `function's body`.
- Sau khi function káº¿t thÃºc. ThÃ¬ `closure` sáº½ khÃ´ng cÃ²n tá»“n táº¡i ná»¯a. ÄÃ“ chÃ­nh lÃ  `lifecycle of the @nonescaping closure`

```swift
func getSumOf(array:[Int], handler: ((Int)->Void)) {
    //step 2
    var sum: Int = 0
    for value in array {
        sum += value
    }

    //step 3
    handler(sum)
}

func doSomething() {
    //setp 1
    self.getSumOf(array: [16,756,442,6,23]) { (sum) in
        print(sum)
        //step 4, finishing the execution
    }
}

//It will print the sumof all the passed numbers.
```

### Escaping Closure

- Khi báº¡n truyá»n `closure` nhÆ° lÃ  tham sá»‘ cá»§a function.
- Báº¡n gá»i nÃ³ trong `function's body`.
- Sau khi function káº¿t thÃºc. ThÃ¬ `closure`sáº½ váº«n cÃ²n tá»“n táº¡i, nÃ³ váº«n Ä‘Æ°á»£c thá»±c hiá»‡n náº¿u Ä‘Æ°á»£c gá»i. ÄÃ“ chÃ­nh lÃ  sá»± khÃ¡c biá»‡t giá»¯a chÃºng.

--> Váº­y thÃ¬ khi nÃ o closure pháº£i cáº§n Ä‘á»‹nh nghÄ©a `@escaping`

### Storage:

- Khi báº¡n cáº§n lÆ°u trá»¯ `closure` bá»Ÿi má»™t `global variable, property`

```swift
var completionHandler: ((Int)->Void)?
func getSumOf(array:[Int], handler: @escaping ((Int)->Void)) {
    //step 2
    var sum: Int = 0
    for value in array {
        sum += value
    }
    //step 3
    self.completionHandler = handler
}

func doSomething() {
    //setp 1
    self.getSumOf(array: [16,756,442,6,23]) { (sum) in
        print(sum)
        //step 4, finishing the execution
    }
}
//Here we are storing the closure for future use.
//It will print the sumof all the passed numbers.
```



## Asynchronous Execution

TrÆ°á»ng há»£p nÃ y thÃ¬ cÃ¡c báº¡n Ä‘Ã£ gáº·p quÃ¡ nhiá»u trong láº­p trÃ¬nh rá»“i Ä‘Ãºng khÃ´ng?. ChÃ­nh lÃ  pháº§n Ä‘áº·t váº¥n Ä‘á» mÃ¬nh Ä‘Ã£ nÃªu á»Ÿ trÃªn Ä‘Ã³ ğŸ˜º

```swift
func getSumOf(array:[Int], handler: @escaping ((Int)->Void)) {
    //step 2
    var sum: Int = 0
    for value in array {
        sum += value
    }
    //step 3
    Globals.delay(0.3, closure: {
        handler(sum)
    })
}

func doSomething() {
    //setp 1
    self.getSumOf(array: [16,756,442,6,23]) { (sum) in
        print(sum)
        //step 4, finishing the execution
    }
}
//Here we are calling the closure with the delay of 0.3 seconds
//It will print the sumof all the passed numbers.
```

### Váº­y quay láº¡i cÃ¢u há»i **WHY** trong `Swift 3` máº·c Ä‘á»‹nh lÃ  `@non-escaping closure`

Sáº½ cÃ³ ráº¥t nhiá»u Æ°u Ä‘iá»ƒm khi closure máº·c Ä‘á»‹nh lÃ  `@non-escaping`

- Lá»£i Ã­ch lá»›n nháº¥t lÃ  vá» hiá»‡u nÄƒng cÅ©ng nhÆ° tá»‘i Æ°u hoÃ¡ quÃ¡ trÃ¬nh complier. Bá»Ÿi vÃ¬ náº¿u trÃ¬nh biÃªn dá»‹ch biáº¿t `closure` Ä‘Ã³ lÃ  `@non-escaping` thÃ¬ nÃ³ sáº½ cáº¥p phÃ¡t vÃ¹ng nhá»› cho `closure` Ä‘Ã³.
- ChÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng `self` mÃ  khÃ´ng cÃ³ báº¥t cá»© váº¥n Ä‘á» gÃ¬ bÃªn trong `@non-escaping closure`. VÃ¬ viá»‡c thá»±c hiá»‡n closure luÃ´n xáº£y ra trÆ°á»›c khi func Ä‘Ã³ káº¿t thÃºc.



## Autoclosures

**KhÃ¡i niá»‡m**: `@autocloure` lÃ  má»™t closure Ä‘Æ°á»£c tá»± Ä‘á»™ng táº¡o ra Ä‘á»ƒ wrap `expression closure` mÃ  nÃ³ Ä‘Æ°á»£c truyá»n vÃ o nhÆ° lÃ  tham sá»‘ cá»§a function.

**Example**: KhÃ´ng sá»­ dá»¥ng `@autoclosure`

```swift
// Khai bao mÃ£ng string
var customersInLine = ["Chris", "Alex", "Ewa", "Barry", "Daniella"]

func serve(customer customerProvider: () -> String) {
    print("Now serving \(customerProvider())!")
}
serve(customer: { customersInLine.remove(at: 0) } )
// Prints "Now serving Alex!"
```

**Example**: Sá»­ dá»¥ng `@autoclosure`

```swift
// customersInLine is ["Ewa", "Barry", "Daniella"]
func serve(customer customerProvider: @autoclosure () -> String) {
    print("Now serving \(customerProvider())!")
}
serve(customer: customersInLine.remove(at: 0))
// Prints "Now serving Ewa!"
```



## Lá»i káº¿t:

NhÆ° váº¥n Ä‘á» Ä‘Æ°á»£c Ä‘áº·t ra tá»« Ä‘áº§u, Closure giÃºp chÃºng ta giáº£i quyáº¿t nhá»¯ng váº«n Ä‘á» vá» báº¥t Ä‘á»“ng bá»™ trong Swift.

Closure Ä‘Æ°á»£c dÃ¹ng ráº¥t nhiá»u trong source code Swift, náº¿u biáº¿t syntax thÃ¬ sáº½ dá»… dÃ ng hÆ¡n trong viá»‡c Ä‘á»c source code, náº¯m Ä‘Æ°á»£c cÃ¡c Æ°u Ä‘iá»ƒm vÃ  á»©ng dá»¥ng Ä‘Ãºng lÃºc sáº½ Ä‘em láº¡i source code ngáº¯n gá»n vÃ  hiá»‡u quáº£ hÆ¡nâ€¦